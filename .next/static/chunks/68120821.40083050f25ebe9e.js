(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[333],{3219:function(e,t){var r;(r=function(e){"use strict";var t=function(e,r){return(t=Object.setPrototypeOf||({__proto__:[]})instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])})(e,r)};function r(e,r){if("function"!=typeof r&&null!==r)throw TypeError("Class extends value "+String(r)+" is not a constructor or null");function n(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}var n=function(){return(n=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var a in t=arguments[r])Object.prototype.hasOwnProperty.call(t,a)&&(e[a]=t[a]);return e}).apply(this,arguments)};function a(e,t,r,n){return new(r||(r=Promise))(function(a,s){function i(e){try{o(n.next(e))}catch(t){s(t)}}function u(e){try{o(n.throw(e))}catch(t){s(t)}}function o(e){var t;e.done?a(e.value):((t=e.value)instanceof r?t:new r(function(e){e(t)})).then(i,u)}o((n=n.apply(e,t||[])).next())})}function s(e,t){var r,n,a,s,i={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return s={next:u(0),throw:u(1),return:u(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function u(s){return function(u){return function(s){if(r)throw TypeError("Generator is already executing.");for(;i;)try{if(r=1,n&&(a=2&s[0]?n.return:s[0]?n.throw||((a=n.return)&&a.call(n),0):n.next)&&!(a=a.call(n,s[1])).done)return a;switch(n=0,a&&(s=[2&s[0],a.value]),s[0]){case 0:case 1:a=s;break;case 4:return i.label++,{value:s[1],done:!1};case 5:i.label++,n=s[1],s=[0];continue;case 7:s=i.ops.pop(),i.trys.pop();continue;default:if(!(a=(a=i.trys).length>0&&a[a.length-1])&&(6===s[0]||2===s[0])){i=0;continue}if(3===s[0]&&(!a||s[1]>a[0]&&s[1]<a[3])){i.label=s[1];break}if(6===s[0]&&i.label<a[1]){i.label=a[1],a=s;break}if(a&&i.label<a[2]){i.label=a[2],i.ops.push(s);break}a[2]&&i.ops.pop(),i.trys.pop();continue}s=t.call(e,i)}catch(u){s=[6,u],n=0}finally{r=a=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,u])}}}function i(e){return this instanceof i?(this.v=e,this):new i(e)}function u(e,t,r){if(!Symbol.asyncIterator)throw TypeError("Symbol.asyncIterator is not defined.");var n,a=r.apply(e,t||[]),s=[];return n={},u("next"),u("throw"),u("return"),n[Symbol.asyncIterator]=function(){return this},n;function u(e){a[e]&&(n[e]=function(t){return new Promise(function(r,n){s.push([e,t,r,n])>1||o(e,t)})})}function o(e,t){try{var r;r=a[e](t),r.value instanceof i?Promise.resolve(r.value.v).then(c,l):f(s[0][2],r)}catch(n){f(s[0][3],n)}}function c(e){o("next",e)}function l(e){o("throw",e)}function f(e,t){e(t),s.shift(),s.length&&o(s[0][0],s[0][1])}}function o(e){if(!Symbol.asyncIterator)throw TypeError("Symbol.asyncIterator is not defined.");var t,r=e[Symbol.asyncIterator];return r?r.call(e):(e=function e(t){var r="function"==typeof Symbol&&Symbol.iterator,n=r&&t[r],a=0;if(n)return n.call(t);if(t&&"number"==typeof t.length)return{next:function(){return t&&a>=t.length&&(t=void 0),{value:t&&t[a++],done:!t}}};throw TypeError(r?"Object is not iterable.":"Symbol.iterator is not defined.")}(e),t={},n("next"),n("throw"),n("return"),t[Symbol.asyncIterator]=function(){return this},t);function n(r){t[r]=e[r]&&function(t){return new Promise(function(n,a){(function(e,t,r,n){Promise.resolve(n).then(function(t){e({value:t,done:r})},t)})(n,a,(t=e[r](t)).done,t.value)})}}}var c=function(){function e(e,t,r){this.allowBoost=!1,this.string=e,this.marks=t,this.index=0,this.parseOptions=r}return e.prototype.hasMark=function(e){return void 0===e&&(e=0),this.index+e<this.marks.length},e.prototype.getMark=function(e){return void 0===e&&(e=0),this.marks[this.index+e]},e.prototype.shift=function(){this.index+=1},e.prototype.process=function(e){var t=this.marks[this.index];this.shift();var r=e[t.name];if(!r)throw Error("Unknown handler: ".concat(t.name));return r.call(e,this,t)},e.prototype.processString=function(){return this.shift(),this.processStringEnd()},e.prototype.processStringEnd=function(){var e=this.marks[this.index-1],t=this.marks[this.index];return this.shift(),this.string.slice(e.position,t.position)},e.prototype.slice=function(e){var t=this.marks[this.index].position;return this.string.slice(t,t+e)},e}(),l=/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(\.\d+)?(Z|([-+]\d{2}:\d{2}))$/;function f(e,t){for(var r=e.toString();r.length<t;)r="0".concat(r);return r}function p(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}var h=function(){function e(e){this.pattern=e,this.patternRe=function(e){for(var t=[],r=0,n=e.split(".");r<n.length;r++){var a=n[r];"*"===a?t.push("[^.]+"):"**"===a?t.push(".*"):t.push(p(a))}return RegExp("^".concat(t.join("."),"$"))}(e)}return e.prototype.matches=function(e){return this.patternRe.test(e)},e.prototype.toJSON=function(){return this.pattern},e}(),d=function(){function e(e){this.type="stream",this.generator=e,this.ticker=null,this.isDone=!1,this.data=[]}return e.prototype.isArray=function(){return!0},e.prototype.get=function(){var e,t;return a(this,void 0,void 0,function(){var r,n,a,i,u,c,l;return s(this,function(s){switch(s.label){case 0:r=[],s.label=1;case 1:s.trys.push([1,7,8,13]),n=o(this),s.label=2;case 2:return[4,n.next()];case 3:if((a=s.sent()).done)return[3,6];return i=a.value,c=(u=r).push,[4,i.get()];case 4:c.apply(u,[s.sent()]),s.label=5;case 5:return[3,2];case 6:return[3,13];case 7:return e={error:s.sent()},[3,13];case 8:if(s.trys.push([8,,11,12]),!(a&&!a.done&&(t=n.return)))return[3,10];return[4,t.call(n)];case 9:s.sent(),s.label=10;case 10:return[3,12];case 11:if(e)throw e.error;return[7];case 12:return[7];case 13:return[2,r]}})})},e.prototype[Symbol.asyncIterator]=function(){return u(this,arguments,function(){var e;return s(this,function(t){switch(t.label){case 0:e=0,t.label=1;case 1:t.label=2;case 2:if(!(e<this.data.length))return[3,6];return[4,i(this.data[e])];case 3:return[4,t.sent()];case 4:t.sent(),t.label=5;case 5:return e++,[3,2];case 6:if(!this.isDone)return[3,8];return[4,i(void 0)];case 7:return[2,t.sent()];case 8:return[4,i(this._nextTick())];case 9:return t.sent(),[3,1];case 10:return[2]}})})},e.prototype._nextTick=function(){var e,t=this;if(this.ticker)return this.ticker;var r=function(){t.ticker=new Promise(function(t){e=t})},n=function(){e(),r()};return r(),a(t,void 0,void 0,function(){var e,t,r,a,i,u;return s(this,function(a){switch(a.label){case 0:a.trys.push([0,5,6,11]),e=o(this.generator()),a.label=1;case 1:return[4,e.next()];case 2:if((t=a.sent()).done)return[3,4];r=t.value,this.data.push(r),n(),a.label=3;case 3:return[3,1];case 4:return[3,11];case 5:return i={error:a.sent()},[3,11];case 6:if(a.trys.push([6,,9,10]),!(t&&!t.done&&(u=e.return)))return[3,8];return[4,u.call(e)];case 7:a.sent(),a.label=8;case 8:return[3,10];case 9:if(i)throw i.error;return[7];case 10:return[7];case 11:return this.isDone=!0,n(),[2]}})}),this.ticker},e}(),y=function(){function e(e,t){this.data=e,this.type=t}return e.prototype.isArray=function(){return"array"===this.type},e.prototype.get=function(){return a(this,void 0,void 0,function(){return s(this,function(e){return[2,this.data]})})},e.prototype[Symbol.asyncIterator]=function(){if(Array.isArray(this.data))return function(e){var t,r,n;return s(this,function(n){switch(n.label){case 0:t=0,r=e,n.label=1;case 1:if(!(t<r.length))return[3,4];return[4,_(r[t])];case 2:n.sent(),n.label=3;case 3:return t++,[3,1];case 4:return[2]}})}(this.data);throw Error("Cannot iterate over: ".concat(this.type))},e}(),b=new y(null,"null"),v=new y(!0,"boolean"),m=new y(!1,"boolean"),w=function(){function e(e){this.date=e}return e.parseToValue=function(t){var r,n=l.test(t)?new Date(t):null;return n?new y(new e(n),"datetime"):b},e.prototype.equals=function(e){return this.date.getTime()==e.date.getTime()},e.prototype.add=function(t){var r=new Date(this.date.getTime());return r.setTime(r.getTime()+1e3*t),new e(r)},e.prototype.difference=function(e){return(this.date.getTime()-e.date.getTime())/1e3},e.prototype.compareTo=function(e){return this.date.getTime()-e.date.getTime()},e.prototype.toString=function(){var e,t,r,n,a,s,i,u,o;return t=f((e=this.date).getUTCFullYear(),4),r=f(e.getUTCMonth()+1,2),n=f(e.getUTCDate(),2),a=f(e.getUTCHours(),2),s=f(e.getUTCMinutes(),2),i=f(e.getUTCSeconds(),2),u="",0!=(o=e.getMilliseconds())&&(u=".".concat(f(o,3))),"".concat(t,"-").concat(r,"-").concat(n,"T").concat(a,":").concat(s,":").concat(i).concat(u,"Z")},e.prototype.toJSON=function(){return this.toString()},e}();function g(e){return Number.isFinite(e)?new y(e,"number"):b}function k(e){return new y(e,"string")}function x(e){return new y(e,"datetime")}function _(e){var t;return e&&"function"==typeof e.next?new d(function(){return u(this,arguments,function(){var t,r,n,a,u,c;return s(this,function(n){switch(n.label){case 0:n.trys.push([0,7,8,13]),t=o(e),n.label=1;case 1:return[4,i(t.next())];case 2:if((r=n.sent()).done)return[3,6];return[4,i(_(r.value))];case 3:return[4,n.sent()];case 4:n.sent(),n.label=5;case 5:return[3,1];case 6:return[3,13];case 7:return u={error:n.sent()},[3,13];case 8:if(n.trys.push([8,,11,12]),!(r&&!r.done&&(c=t.return)))return[3,10];return[4,i(c.call(t))];case 9:n.sent(),n.label=10;case 10:return[3,12];case 11:if(u)throw u.error;return[7];case 12:return[7];case 13:return[2]}})})}):null==e?b:new y(e,E(e))}function E(e){return null==e?"null":Array.isArray(e)?"array":e instanceof h?"path":e instanceof w?"datetime":typeof e}var A={datetime:1,number:2,string:3,boolean:4};function S(e,t){var r=E(e),n=E(t);if(r!==n)return null;switch(r){case"number":case"boolean":return e-t;case"string":if(e<t)return -1;if(e>t)return 1;return 0;case"datetime":return e.compareTo(t);default:return null}}function j(e,t){var r=E(e),n=E(t),a=A[r]||100,s=A[n]||100;if(a!==s)return a-s;var i=S(e,t);return null===i&&(i=0),i}var O=/([^!@#$%^&*(),\\/?";:{}|[\]+<>\s-])+/g,I=/([^!@#$%^&(),\\/?";:{}|[\]+<>\s-])+/g,C=/(\b\.+|\.+\b)/g;function T(e){return e.replace(C,"").match(O)||[]}function M(e){return(e.replace(C,"").match(I)||[]).map(function(e){return RegExp("^".concat(e.slice(0,1024).replace(/\*/g,".*"),"$"),"i")})}function P(e,t){var r,n,i,u;return a(this,void 0,void 0,function(){var a,c,l;return s(this,function(s){switch(s.label){case 0:if("string"===e.type)return t(e.data),[2,!0];if(!e.isArray())return[3,13];a=!0,s.label=1;case 1:s.trys.push([1,6,7,12]),r=o(e),s.label=2;case 2:return[4,r.next()];case 3:if((n=s.sent()).done)return[3,5];"string"===(c=n.value).type?t(c.data):a=!1,s.label=4;case 4:return[3,2];case 5:return[3,12];case 6:return i={error:s.sent()},[3,12];case 7:if(s.trys.push([7,,10,11]),!(n&&!n.done&&(u=r.return)))return[3,9];return[4,u.call(r)];case 8:s.sent(),s.label=9;case 9:return[3,11];case 10:if(i)throw i.error;return[7];case 11:return[7];case 12:return[2,a];case 13:return[2,!1]}})})}function N(e){if("string"!=typeof e._type)return null;var t=e.children;if(!Array.isArray(t))return null;for(var r="",n=0;n<t.length;n++){var a=t[n];a&&"object"==typeof a&&"string"==typeof a._type&&"span"===a._type&&"string"==typeof a.text&&(r+=a.text)}return r}var U={};U.anywhere=function(){return a(this,void 0,void 0,function(){return s(this,function(e){throw Error("not implemented")})})},U.anywhere.arity=1,U.coalesce=function(e,t,r){return a(this,void 0,void 0,function(){var n,a,i,u;return s(this,function(s){switch(s.label){case 0:n=0,a=e,s.label=1;case 1:if(!(n<a.length))return[3,4];return[4,r(a[n],t)];case 2:if("null"!==(u=s.sent()).type)return[2,u];s.label=3;case 3:return n++,[3,1];case 4:return[2,b]}})})},U.count=function(e,t,r){var n,i;return a(this,void 0,void 0,function(){var a,u,c,l,f;return s(this,function(s){switch(s.label){case 0:return[4,r(e[0],t)];case 1:if(!(a=s.sent()).isArray())return[2,b];u=0,s.label=2;case 2:s.trys.push([2,7,8,13]),c=o(a),s.label=3;case 3:return[4,c.next()];case 4:if((l=s.sent()).done)return[3,6];l.value,u++,s.label=5;case 5:return[3,3];case 6:return[3,13];case 7:return n={error:s.sent()},[3,13];case 8:if(s.trys.push([8,,11,12]),!(l&&!l.done&&(i=c.return)))return[3,10];return[4,i.call(c)];case 9:s.sent(),s.label=10;case 10:return[3,12];case 11:if(n)throw n.error;return[7];case 12:return[7];case 13:return[2,g(u)]}})})},U.count.arity=1,U.dateTime=function(e,t,r){return a(this,void 0,void 0,function(){var n;return s(this,function(a){switch(a.label){case 0:return[4,r(e[0],t)];case 1:if("datetime"===(n=a.sent()).type)return[2,n];if("string"!==n.type)return[2,b];return[2,w.parseToValue(n.data)]}})})},U.dateTime.arity=1,U.defined=function(e,t,r){return a(this,void 0,void 0,function(){var n;return s(this,function(n){switch(n.label){case 0:return[4,r(e[0],t)];case 1:return[2,"null"===n.sent().type?m:v]}})})},U.defined.arity=1,U.identity=function(e,t){return a(this,void 0,void 0,function(){return s(this,function(e){return[2,k(t.context.identity)]})})},U.identity.arity=0,U.length=function(e,t,r){var n,i;return a(this,void 0,void 0,function(){var a,u,c,l,f;return s(this,function(s){switch(s.label){case 0:return[4,r(e[0],t)];case 1:if("string"===(a=s.sent()).type)return[2,g(function(e){for(var t=0,r=0;r<e.length;r++){var n=e.charCodeAt(r);(!(n>=55296)||!(n<=56319))&&t++}return t}(a.data))];if(!a.isArray())return[3,14];u=0,s.label=2;case 2:s.trys.push([2,7,8,13]),c=o(a),s.label=3;case 3:return[4,c.next()];case 4:if((l=s.sent()).done)return[3,6];l.value,u++,s.label=5;case 5:return[3,3];case 6:return[3,13];case 7:return n={error:s.sent()},[3,13];case 8:if(s.trys.push([8,,11,12]),!(l&&!l.done&&(i=c.return)))return[3,10];return[4,i.call(c)];case 9:s.sent(),s.label=10;case 10:return[3,12];case 11:if(n)throw n.error;return[7];case 12:return[7];case 13:return[2,g(u)];case 14:return[2,b]}})})},U.length.arity=1,U.path=function(e,t,r){return a(this,void 0,void 0,function(){var n;return s(this,function(a){switch(a.label){case 0:return[4,r(e[0],t)];case 1:var s;if("string"!==(n=a.sent()).type)return[2,b];return[2,(s=new h(n.data),new y(s,"path"))]}})})},U.path.arity=1,U.string=function(e,t,r){return a(this,void 0,void 0,function(){var n;return s(this,function(a){switch(a.label){case 0:return[4,r(e[0],t)];case 1:switch((n=a.sent()).type){case"number":case"string":case"boolean":case"datetime":return[2,k("".concat(n.data))];default:return[2,b]}return[2]}})})},U.string.arity=1,U.references=function(e,t,r){var n,i;return a(this,void 0,void 0,function(){var a,u,c,l,f,p,h,d,y,b;return s(this,function(s){switch(s.label){case 0:a=new Set,u=0,c=e,s.label=1;case 1:if(!(u<c.length))return[3,16];return[4,r(c[u],t)];case 2:if("string"!==(f=s.sent()).type)return[3,3];return a.add(f.data),[3,15];case 3:if(!f.isArray())return[3,15];s.label=4;case 4:s.trys.push([4,9,10,15]),n=void 0,p=o(f),s.label=5;case 5:return[4,p.next()];case 6:if((h=s.sent()).done)return[3,8];"string"===(d=h.value).type&&a.add(d.data),s.label=7;case 7:return[3,5];case 8:return[3,15];case 9:return n={error:s.sent()},[3,15];case 10:if(s.trys.push([10,,13,14]),!(h&&!h.done&&(i=p.return)))return[3,12];return[4,i.call(p)];case 11:s.sent(),s.label=12;case 12:return[3,14];case 13:if(n)throw n.error;return[7];case 14:return[7];case 15:return u++,[3,1];case 16:if(0===a.size)return[2,m];return[4,t.value.get()];case 17:return[2,!function e(t,r){switch(E(t)){case"array":for(var n=0;n<t.length;n++){var a=t[n];if(e(a,r))return!0}break;case"object":if(t._ref)return r.has(t._ref);for(var s=0,i=Object.values(t);s<i.length;s++){var a=i[s];if(e(a,r))return!0}}return!1}(s.sent(),a)?m:v]}})})},U.references.arity=function(e){return e>=1},U.round=function(e,t,r){return a(this,void 0,void 0,function(){var n,a,i,u;return s(this,function(s){switch(s.label){case 0:return[4,r(e[0],t)];case 1:if("number"!==(n=s.sent()).type)return[2,b];if(a=n.data,i=0,2!==e.length)return[3,3];return[4,r(e[1],t)];case 2:if("number"!==(u=s.sent()).type||u.data<0||!Number.isInteger(u.data))return[2,b];i=u.data,s.label=3;case 3:if(0===i){if(a<0)return[2,g(-Math.round(-a))];return[2,g(Math.round(a))]}return[2,g(Number(a.toFixed(i)))]}})})},U.round.arity=function(e){return e>=1&&e<=2},U.now=function(e,t){return a(this,void 0,void 0,function(){return s(this,function(e){return[2,k(t.context.timestamp.toISOString())]})})},U.now.arity=0,U.boost=function(){return a(this,void 0,void 0,function(){return s(this,function(e){throw Error("unexpected boost call")})})},U.boost.arity=2;var V={};V.lower=function(e,t,r){return a(this,void 0,void 0,function(){var n;return s(this,function(a){switch(a.label){case 0:return[4,r(e[0],t)];case 1:if("string"!==(n=a.sent()).type)return[2,b];return[2,k(n.data.toLowerCase())]}})})},V.lower.arity=1,V.upper=function(e,t,r){return a(this,void 0,void 0,function(){var n;return s(this,function(a){switch(a.label){case 0:return[4,r(e[0],t)];case 1:if("string"!==(n=a.sent()).type)return[2,b];return[2,k(n.data.toUpperCase())]}})})},V.upper.arity=1,V.split=function(e,t,r){return a(this,void 0,void 0,function(){var n,a;return s(this,function(s){switch(s.label){case 0:return[4,r(e[0],t)];case 1:if("string"!==(n=s.sent()).type)return[2,b];return[4,r(e[1],t)];case 2:if("string"!==(a=s.sent()).type)return[2,b];if(0===n.data.length)return[2,_([])];if(0===a.data.length)return[2,_(Array.from(n.data))];return[2,_(n.data.split(a.data))]}})})},V.split.arity=2,U.lower=V.lower,U.upper=V.upper,V.startsWith=function(e,t,r){return a(this,void 0,void 0,function(){var n,a;return s(this,function(s){switch(s.label){case 0:return[4,r(e[0],t)];case 1:if("string"!==(n=s.sent()).type)return[2,b];return[4,r(e[1],t)];case 2:if("string"!==(a=s.sent()).type)return[2,b];return[2,n.data.startsWith(a.data)?v:m]}})})},V.startsWith.arity=2;var D={};D.join=function(e,t,r){var n,i;return a(this,void 0,void 0,function(){var a,u,c,l,f,p,h,d;return s(this,function(s){switch(s.label){case 0:return[4,r(e[0],t)];case 1:if(!(a=s.sent()).isArray())return[2,b];return[4,r(e[1],t)];case 2:if("string"!==(u=s.sent()).type)return[2,b];c="",l=!1,s.label=3;case 3:s.trys.push([3,8,9,14]),f=o(a),s.label=4;case 4:return[4,f.next()];case 5:if((p=s.sent()).done)return[3,7];switch(h=p.value,l&&(c+=u.data),h.type){case"number":case"string":case"boolean":case"datetime":c+="".concat(h.data);break;default:return[2,b]}l=!0,s.label=6;case 6:return[3,4];case 7:return[3,14];case 8:return n={error:s.sent()},[3,14];case 9:if(s.trys.push([9,,12,13]),!(p&&!p.done&&(i=f.return)))return[3,11];return[4,i.call(f)];case 10:s.sent(),s.label=11;case 11:return[3,13];case 12:if(n)throw n.error;return[7];case 13:return[7];case 14:return[2,_(c)]}})})},D.join.arity=2,D.compact=function(e,t,r){return a(this,void 0,void 0,function(){var n;return s(this,function(a){switch(a.label){case 0:return[4,r(e[0],t)];case 1:if(!(n=a.sent()).isArray())return[2,b];return[2,new d(function(){return u(this,arguments,function(){var e,t,r,a,u,c;return s(this,function(a){switch(a.label){case 0:a.trys.push([0,7,8,13]),e=o(n),a.label=1;case 1:return[4,i(e.next())];case 2:if((t=a.sent()).done)return[3,6];if(!("null"!==(r=t.value).type))return[3,5];return[4,i(r)];case 3:return[4,a.sent()];case 4:a.sent(),a.label=5;case 5:return[3,1];case 6:return[3,13];case 7:return u={error:a.sent()},[3,13];case 8:if(a.trys.push([8,,11,12]),!(t&&!t.done&&(c=e.return)))return[3,10];return[4,i(c.call(e))];case 9:a.sent(),a.label=10;case 10:return[3,12];case 11:if(u)throw u.error;return[7];case 12:return[7];case 13:return[2]}})})})]}})})},D.compact.arity=1,D.unique=function(e,t,r){return a(this,void 0,void 0,function(){var n;return s(this,function(a){switch(a.label){case 0:return[4,r(e[0],t)];case 1:if(!(n=a.sent()).isArray())return[2,b];return[2,new d(function(){return u(this,arguments,function(){var e,t,r,a,u,c,l,f;return s(this,function(s){switch(s.label){case 0:e=new Set,s.label=1;case 1:s.trys.push([1,13,14,19]),t=o(n),s.label=2;case 2:return[4,i(t.next())];case 3:if((r=s.sent()).done)return[3,12];switch(u=(a=r.value).type){case"number":case"string":case"boolean":case"datetime":return[3,4]}return[3,8];case 4:if(e.has(a.data))return[3,7];return e.add(a.data),[4,i(a)];case 5:return[4,s.sent()];case 6:s.sent(),s.label=7;case 7:return[3,11];case 8:return[4,i(a)];case 9:return[4,s.sent()];case 10:s.sent(),s.label=11;case 11:return[3,2];case 12:return[3,19];case 13:return l={error:s.sent()},[3,19];case 14:if(s.trys.push([14,,17,18]),!(r&&!r.done&&(f=t.return)))return[3,16];return[4,i(f.call(t))];case 15:s.sent(),s.label=16;case 16:return[3,18];case 17:if(l)throw l.error;return[7];case 18:return[7];case 19:return[2]}})})})]}})})},D.unique.arity=1;var F={};F.text=function(e,t,r){return a(this,void 0,void 0,function(){var n,i;return s(this,function(n){switch(n.label){case 0:return[4,r(e[0],t)];case 1:return[4,function(e){return a(this,void 0,void 0,function(){var t;return s(this,function(r){switch(r.label){case 0:if("object"!==e.type)return[3,1];return[2,N(e.data)];case 1:if(!e.isArray())return[3,3];return[4,function e(t,r){var n,i,u,c;return void 0===r&&(r=[]),a(this,void 0,void 0,function(){var a,l,f;return s(this,function(s){switch(s.label){case 0:s.trys.push([0,7,8,13]),n=o(t),s.label=1;case 1:return[4,n.next()];case 2:if((i=s.sent()).done)return[3,6];if("object"!==(a=i.value).type)return[3,3];return null!==(l=N(a.data))&&r.push(l),[3,5];case 3:if(!a.isArray())return[3,5];return[4,e(a,r)];case 4:s.sent(),s.label=5;case 5:return[3,1];case 6:return[3,13];case 7:return u={error:s.sent()},[3,13];case 8:if(s.trys.push([8,,11,12]),!(i&&!i.done&&(c=n.return)))return[3,10];return[4,c.call(n)];case 9:s.sent(),s.label=10;case 10:return[3,12];case 11:if(u)throw u.error;return[7];case 12:return[7];case 13:return[2,r]}})})}(e)];case 2:if((t=r.sent()).length>0)return[2,t.join("\n\n")];r.label=3;case 3:return[2,null]}})})}(n.sent())];case 2:if(null===(i=n.sent()))return[2,b];return[2,k(i)]}})})},F.text.arity=1;var q={};q.projectId=function(e,t){return a(this,void 0,void 0,function(){return s(this,function(e){return t.context.sanity?[2,k(t.context.sanity.projectId)]:[2,b]})})},q.dataset=function(e,t){return a(this,void 0,void 0,function(){return s(this,function(e){return t.context.sanity?[2,k(t.context.sanity.dataset)]:[2,b]})})};var G={};G.order=function(e,t,r,n){var i,u,c,l;return a(this,void 0,void 0,function(){var a,f,p,h,d,y,v,m,w,g,k,x,E,A,S,O,I;return s(this,function(s){switch(s.label){case 0:return[4,!0];case 1:if(s.sent(),!e.isArray())return[2,b];for(h=0,a=[],f=[],p=0,d=t;h<d.length;h++)y=d[h],v="asc","Desc"===y.type?(v="desc",y=y.base):"Asc"===y.type&&(y=y.base),a.push(y),f.push(v),p++;m=[],w=0,s.label=2;case 2:s.trys.push([2,13,14,19]),i=o(e),s.label=3;case 3:return[4,i.next()];case 4:if((u=s.sent()).done)return[3,12];return g=u.value,k=r.createNested(g),[4,g.get()];case 5:x=[s.sent(),w],E=0,s.label=6;case 6:if(!(E<p))return[3,10];return[4,n(a[E],k)];case 7:return A=s.sent(),O=(S=x).push,[4,A.get()];case 8:O.apply(S,[s.sent()]),s.label=9;case 9:return E++,[3,6];case 10:m.push(x),w++,s.label=11;case 11:return[3,3];case 12:return[3,19];case 13:return c={error:s.sent()},[3,19];case 14:if(s.trys.push([14,,17,18]),!(u&&!u.done&&(l=i.return)))return[3,16];return[4,l.call(i)];case 15:s.sent(),s.label=16;case 16:return[3,18];case 17:if(c)throw c.error;return[7];case 18:return[7];case 19:return m.sort(function(e,t){for(var r=0;r<p;r++){var n=j(e[r+2],t[r+2]);if("desc"===f[r]&&(n=-n),0!==n)return n}return e[1]-t[1]}),[2,_(m.map(function(e){return e[0]}))]}})})},G.order.arity=function(e){return e>=1},G.score=function(e,t,r,n){var i,u,c,l;return a(this,void 0,void 0,function(){var f,p,h,d,y,v,m,w,g,k,x,E,A;return s(this,function(A){switch(A.label){case 0:if(!e.isArray())return[2,b];f=[],p=[],A.label=1;case 1:A.trys.push([1,12,13,18]),i=o(e),A.label=2;case 2:return[4,i.next()];case 3:if((u=A.sent()).done)return[3,11];if(!("object"!==(h=u.value).type))return[3,5];return y=(d=f).push,[4,h.get()];case 4:return y.apply(d,[A.sent()]),[3,10];case 5:v=r.createNested(h),m="number"==typeof h.data._score?h.data._score:0,w=0,g=t,A.label=6;case 6:if(!(w<g.length))return[3,9];return k=g[w],x=m,[4,function e(t,r,n){return a(this,void 0,void 0,function(){var i,u,o,c,l,f;return s(this,function(p){switch(p.label){case 0:if("OpCall"===t.type&&"match"===t.op)return[2,function(e,t,r,n){return a(this,void 0,void 0,function(){var a,i,u,o,c,l,f,p,h,d;return s(this,function(s){switch(s.label){case 0:return[4,n(e,r)];case 1:return a=s.sent(),[4,n(t,r)];case 2:return i=s.sent(),u=[],o=[],[4,P(a,function(e){u=u.concat(T(e))})];case 3:return s.sent(),[4,P(i,function(e){o=o.concat(M(e))})];case 4:if(!s.sent()||0===u.length||0===o.length)return[2,0];for(p=0,l=0,f=function(e){var t=u.reduce(function(t,r){return t+(e.test(r)?1:0)},0);l+=2.2*t/(t+1.2)},h=o;p<h.length;p++)f(h[p]);return[2,l]}})})}(t.left,t.right,r,n)];if(!("FuncCall"===t.type&&"boost"===t.name))return[3,3];return[4,e(t.args[0],r,n)];case 1:return i=p.sent(),[4,n(t.args[1],r)];case 2:if("number"===(u=p.sent()).type&&i>0)return[2,i+u.data];return[2,0];case 3:switch(o=t.type){case"Or":return[3,4];case"And":return[3,7]}return[3,10];case 4:case 7:return[4,e(t.left,r,n)];case 5:case 8:return c=p.sent(),[4,e(t.right,r,n)];case 6:return[2,c+(l=p.sent())];case 9:if(l=p.sent(),0===c||0===l)return[2,0];return[2,c+l];case 10:return[4,n(t,r)];case 11:return[2,"boolean"===(f=p.sent()).type&&!0===f.data?1:0]}})})}(k,v,n)];case 7:m=x+A.sent(),A.label=8;case 8:return w++,[3,6];case 9:E=Object.assign({},h.data,{_score:m}),p.push(E),A.label=10;case 10:return[3,2];case 11:return[3,18];case 12:return c={error:A.sent()},[3,18];case 13:if(A.trys.push([13,,16,17]),!(u&&!u.done&&(l=i.return)))return[3,15];return[4,l.call(i)];case 14:A.sent(),A.label=15;case 15:return[3,17];case 16:if(c)throw c.error;return[7];case 17:return[7];case 18:return p.sort(function(e,t){return t._score-e._score}),[2,_(p)]}})})},G.score.arity=function(e){return e>=1};var $={};$.operation=function(e,t){return a(this,void 0,void 0,function(){var e,r;return s(this,function(n){return(e=null!==t.context.before,r=null!==t.context.after,e&&r)?[2,k("update")]:r?[2,k("create")]:e?[2,k("delete")]:[2,b]})})},$.changedAny=function(){throw Error("not implemented")},$.changedAny.arity=1,$.changedAny.mode="delta",$.changedOnly=function(){throw Error("not implemented")},$.changedOnly.arity=1,$.changedOnly.mode="delta";var B={};B.changedAny=function(){throw Error("not implemented")},B.changedAny.arity=3,B.changedOnly=function(){throw Error("not implemented")},B.changedOnly.arity=3;var H={};H.min=function(e,t,r){var n,i;return a(this,void 0,void 0,function(){var a,u,c,l,f,p;return s(this,function(s){switch(s.label){case 0:return[4,r(e[0],t)];case 1:if(!(a=s.sent()).isArray())return[2,b];u=void 0,s.label=2;case 2:s.trys.push([2,7,8,13]),c=o(a),s.label=3;case 3:return[4,c.next()];case 4:if((l=s.sent()).done)return[3,6];if("null"===(f=l.value).type)return[3,5];if("number"!==f.type)return[2,b];(void 0===u||f.data<u)&&(u=f.data),s.label=5;case 5:return[3,3];case 6:return[3,13];case 7:return n={error:s.sent()},[3,13];case 8:if(s.trys.push([8,,11,12]),!(l&&!l.done&&(i=c.return)))return[3,10];return[4,i.call(c)];case 9:s.sent(),s.label=10;case 10:return[3,12];case 11:if(n)throw n.error;return[7];case 12:return[7];case 13:return[2,_(u)]}})})},H.min.arity=1,H.max=function(e,t,r){var n,i;return a(this,void 0,void 0,function(){var a,u,c,l,f,p;return s(this,function(s){switch(s.label){case 0:return[4,r(e[0],t)];case 1:if(!(a=s.sent()).isArray())return[2,b];u=void 0,s.label=2;case 2:s.trys.push([2,7,8,13]),c=o(a),s.label=3;case 3:return[4,c.next()];case 4:if((l=s.sent()).done)return[3,6];if("null"===(f=l.value).type)return[3,5];if("number"!==f.type)return[2,b];(void 0===u||f.data>u)&&(u=f.data),s.label=5;case 5:return[3,3];case 6:return[3,13];case 7:return n={error:s.sent()},[3,13];case 8:if(s.trys.push([8,,11,12]),!(l&&!l.done&&(i=c.return)))return[3,10];return[4,i.call(c)];case 9:s.sent(),s.label=10;case 10:return[3,12];case 11:if(n)throw n.error;return[7];case 12:return[7];case 13:return[2,_(u)]}})})},H.max.arity=1,H.sum=function(e,t,r){var n,i;return a(this,void 0,void 0,function(){var a,u,c,l,f,p;return s(this,function(s){switch(s.label){case 0:return[4,r(e[0],t)];case 1:if(!(a=s.sent()).isArray())return[2,b];u=0,s.label=2;case 2:s.trys.push([2,7,8,13]),c=o(a),s.label=3;case 3:return[4,c.next()];case 4:if((l=s.sent()).done)return[3,6];if("null"===(f=l.value).type)return[3,5];if("number"!==f.type)return[2,b];u+=f.data,s.label=5;case 5:return[3,3];case 6:return[3,13];case 7:return n={error:s.sent()},[3,13];case 8:if(s.trys.push([8,,11,12]),!(l&&!l.done&&(i=c.return)))return[3,10];return[4,i.call(c)];case 9:s.sent(),s.label=10;case 10:return[3,12];case 11:if(n)throw n.error;return[7];case 12:return[7];case 13:return[2,_(u)]}})})},H.sum.arity=1,H.avg=function(e,t,r){var n,i;return a(this,void 0,void 0,function(){var a,u,c,l,f,p,h;return s(this,function(s){switch(s.label){case 0:return[4,r(e[0],t)];case 1:if(!(a=s.sent()).isArray())return[2,b];u=0,c=0,s.label=2;case 2:s.trys.push([2,7,8,13]),l=o(a),s.label=3;case 3:return[4,l.next()];case 4:if((f=s.sent()).done)return[3,6];if("null"===(p=f.value).type)return[3,5];if("number"!==p.type)return[2,b];u+=p.data,c++,s.label=5;case 5:return[3,3];case 6:return[3,13];case 7:return n={error:s.sent()},[3,13];case 8:if(s.trys.push([8,,11,12]),!(f&&!f.done&&(i=l.return)))return[3,10];return[4,i.call(l)];case 9:s.sent(),s.label=10;case 10:return[3,12];case 11:if(n)throw n.error;return[7];case 12:return[7];case 13:if(0===c)return[2,b];return[2,_(u/c)]}})})},H.avg.arity=1;var R={global:U,string:V,array:D,pt:F,delta:$,diff:B,sanity:q,math:H};let Z=/^([\t\n\v\f\r \u0085\u00A0]|(\/\/[^\n]*\n))+/,z=/^\d+/,W=/^[a-zA-Z_][a-zA-Z_0-9]*/;function J(e,t,r){let n=t,a=e[t],s;switch(a){case"+":{let i=J(e,K(e,t+1),10);if("error"===i.type)return i;s=[{name:"pos",position:n}].concat(i.marks),t=i.position;break}case"-":{let u=J(e,K(e,t+1),8);if("error"===u.type)return u;s=[{name:"neg",position:n}].concat(u.marks),t=u.position;break}case"(":{let o=J(e,K(e,t+1),0);if("error"===o.type)return o;switch(e[t=K(e,o.position)]){case",":for(s=[{name:"tuple",position:n}].concat(o.marks),t=K(e,t+1);;){if("error"===(o=J(e,t,0)).type)return o;if(","!==e[t=K(e,o.position)])break;t=K(e,t+1)}if(")"!==e[t])return{type:"error",position:t};t++,s.push({name:"tuple_end",position:t});break;case")":t++,s=[{name:"group",position:n}].concat(o.marks);break;default:return{type:"error",position:t}}break}case"!":{let c=J(e,K(e,t+1),10);if("error"===c.type)return c;s=[{name:"not",position:n}].concat(c.marks),t=c.position;break}case"{":{let l=Y(e,t);if("error"===l.type)return l;s=l.marks,t=l.position;break}case"[":if(s=[{name:"array",position:t}],"]"!==e[t=K(e,t+1)])for(;;){"..."===e.slice(t,t+3)&&(s.push({name:"array_splat",position:t}),t=K(e,t+3));let f=J(e,t,0);if("error"===f.type)return f;if(s=s.concat(f.marks),","!==e[t=K(e,t=f.position)]||"]"===e[t=K(e,t+1)])break}if("]"!==e[t])return{type:"error",position:t};t++,s.push({name:"array_end",position:t});break;case"'":case'"':{let p=function e(t,r){let n=t[r];r+=1;let a=[{name:"str",position:r}];str:for(;;r++){if(r>t.length)return{type:"error",position:r};switch(t[r]){case n:a.push({name:"str_end",position:r}),r++;break str;case"\\":a.push({name:"str_pause",position:r}),"u"===t[r+1]?"{"===t[r+2]?(a.push({name:"unicode_hex",position:r+3}),r=t.indexOf("}",r+3),a.push({name:"unicode_hex_end",position:r})):(a.push({name:"unicode_hex",position:r+2}),a.push({name:"unicode_hex_end",position:r+6}),r+=5):(a.push({name:"single_escape",position:r+1}),r+=1),a.push({name:"str_start",position:r+1})}}return{type:"success",marks:a,position:r}}(e,t);if("error"===p.type)return p;s=p.marks,t=p.position;break}case"^":for(t++,s=[];"."===e[t]&&"^"===e[t+1];)s.push({name:"dblparent",position:n}),t+=2;s.push({name:"parent",position:n});break;case"@":s=[{name:"this",position:n}],t++;break;case"*":s=[{name:"everything",position:n}],t++;break;case"$":{let h=X(e,t+1,W);h&&(t+=1+h,s=[{name:"param",position:n},{name:"ident",position:n+1},{name:"ident_end",position:t},]);break}default:{let d=X(e,t,z);if(d){let y="integer";if("."===e[t+=d]){let b=X(e,t+1,z);b&&(y="float",t+=1+b)}if("e"===e[t]||"E"===e[t]){y="sci",("+"===e[++t]||"-"===e[t])&&t++;let v=X(e,t,z);if(!v)return{type:"error",position:t};t+=v}s=[{name:y,position:n},{name:y+"_end",position:t},];break}let m=X(e,t,W);if(m)switch(e[t+=m]){case":":case"(":{let w=L(e,n,t);if("error"===w.type)return w;s=w.marks,t=w.position;break}default:s=[{name:"this_attr",position:n},{name:"ident",position:n},{name:"ident_end",position:t},]}}}if(!s)return{type:"error",position:t};let g=12,k;loop:for(;;){let x=K(e,t);if(x===e.length){t=x;break}if("success"===(k=Q(e,x)).type){for(s.unshift({name:"traverse",position:n});"success"===k.type;)s=s.concat(k.marks),k=Q(e,K(e,t=k.position));s.push({name:"traversal_end",position:t});continue}let _=e[x];switch(_){case"=":{let E=e[x+1];switch(E){case">":{if(r>1||g<=1)break loop;let A=J(e,K(e,x+2),1);if("error"===A.type)return A;(s=s.concat(A.marks)).unshift({name:"pair",position:n}),t=A.position,g=1;break}case"=":{if(r>4||g<=4)break loop;let S=J(e,K(e,x+2),5);if("error"===S.type)return S;s.unshift({name:"comp",position:n}),s.push({name:"op",position:x},{name:"op_end",position:x+2}),s=s.concat(S.marks),t=S.position,g=4;break}default:break loop}break}case"+":{if(r>6||g<6)break loop;let j=J(e,K(e,x+1),7);if("error"===j.type)return j;(s=s.concat(j.marks)).unshift({name:"add",position:n}),t=j.position,g=6;break}case"-":{if(r>6||g<6)break loop;let O=J(e,K(e,x+1),7);if("error"===O.type)return O;(s=s.concat(O.marks)).unshift({name:"sub",position:n}),t=O.position,g=6;break}case"*":{if("*"===e[x+1]){if(r>8||g<=8)break loop;let I=J(e,K(e,x+2),8);if("error"===I.type)return I;(s=s.concat(I.marks)).unshift({name:"pow",position:n}),t=I.position,g=8;break}if(r>7||g<7)break loop;let C=J(e,K(e,x+1),8);if("error"===C.type)return C;(s=s.concat(C.marks)).unshift({name:"mul",position:n}),t=C.position,g=7;break}case"/":{if(r>7||g<7)break loop;let T=J(e,K(e,x+1),8);if("error"===T.type)return T;(s=s.concat(T.marks)).unshift({name:"div",position:n}),t=T.position,g=7;break}case"%":{if(r>7||g<7)break loop;let M=J(e,K(e,x+1),8);if("error"===M.type)return M;(s=s.concat(M.marks)).unshift({name:"mod",position:n}),t=M.position,g=7;break}case"<":case">":{if(r>4||g<=4)break loop;let P=x+1;"="===e[P]&&P++;let N=J(e,K(e,P),5);if("error"===N.type)return N;s.unshift({name:"comp",position:n}),s.push({name:"op",position:x},{name:"op_end",position:P}),s=s.concat(N.marks),t=N.position,g=4;break}case"|":if("|"===e[x+1]){if(r>2||g<2)break loop;let U=J(e,K(e,x+2),3);if("error"===U.type)return U;(s=s.concat(U.marks)).unshift({name:"or",position:n}),t=U.position,g=2}else{if(r>11||g<11)break loop;let V=K(e,x+1),D=X(e,V,W);if(!D)return{type:"error",position:V};if("("===e[t=V+D]||":"===e[t]){let F=L(e,V,t);if("error"===F.type)return F;(s=s.concat(F.marks)).unshift({name:"pipecall",position:n}),t=F.position,g=11}}break;case"&":{if("&"!=e[x+1]||r>3||g<3)break loop;let q=J(e,K(e,x+2),4);if("error"===q.type)return q;(s=s.concat(q.marks)).unshift({name:"and",position:n}),t=q.position,g=3;break}case"!":{if("="!==e[x+1]||r>4||g<4)break loop;let G=J(e,K(e,x+2),5);if("error"===G.type)return G;s.unshift({name:"comp",position:n}),s.push({name:"op",position:x},{name:"op_end",position:x+2}),s=s.concat(G.marks),t=G.position,g=4;break}case"d":if("desc"!==e.slice(x,x+4)||r>4||g<4)break loop;s.unshift({name:"desc",position:n}),t=x+4,g=4;break;case"a":if("asc"!==e.slice(x,x+3)||r>4||g<4)break loop;s.unshift({name:"asc",position:n}),t=x+3,g=4;break;default:{let $=ee(e,x,W);switch($){case"in":{if(r>4||g<=4)break loop;t=K(e,x+2);let B=!1;"("===e[t]&&(B=!0,t=K(e,t+1));let H=t,R=J(e,t,5);if("error"===R.type)return R;if("."===e[t=K(e,R.position)]&&"."===e[t+1]){let Z="inc_range";"."===e[t+2]?(Z="exc_range",t=K(e,t+3)):t=K(e,t+2);let et=J(e,t,5);if("error"===et.type)return et;s.unshift({name:"in_range",position:n}),s=s.concat({name:Z,position:H},R.marks,et.marks),t=et.position}else s.unshift({name:"comp",position:n}),s.push({name:"op",position:x},{name:"op_end",position:x+2}),s=s.concat(R.marks);if(B){if(")"!==e[t=K(e,t)])return{type:"error",position:t};t++}g=4;break}case"match":{if(r>4||g<=4)break loop;let er=J(e,K(e,x+5),5);if("error"===er.type)return er;s.unshift({name:"comp",position:n}),s.push({name:"op",position:x},{name:"op_end",position:x+5}),s=s.concat(er.marks),t=er.position,g=4;break}default:break loop}}}}let en=k?.type==="error"&&k.position;return{type:"success",marks:s,position:t,failPosition:en}}function Q(e,t){let r=t;switch(e[t]){case".":{let n=t=K(e,t+1),a=X(e,t,W);if(!a)return{type:"error",position:t};return{type:"success",marks:[{name:"attr_access",position:r},{name:"ident",position:n},{name:"ident_end",position:t+=a},],position:t}}case"-":if(">"!==e[t+1])break;let s=[{name:"deref",position:r}],i=K(e,t+=2),u=X(e,i,W);return u&&(t=i+u,s.push({name:"deref_attr",position:i},{name:"ident",position:i},{name:"ident_end",position:t})),{type:"success",marks:s,position:t};case"[":{if("]"===e[t=K(e,t+1)])return{type:"success",marks:[{name:"array_postfix",position:r}],position:t+1};let o=t,c=J(e,t,0);if("error"===c.type)return c;if("."===e[t=K(e,c.position)]&&"."===e[t+1]){let l="inc_range";"."===e[t+2]?(l="exc_range",t+=3):t+=2,t=K(e,t);let f=J(e,t,0);if("error"===f.type)return f;if("]"!==e[t=K(e,f.position)])return{type:"error",position:t};return{type:"success",marks:[{name:"slice",position:r},{name:l,position:o},].concat(c.marks,f.marks),position:t+1}}if("]"!==e[t])return{type:"error",position:t};return{type:"success",marks:[{name:"square_bracket",position:r}].concat(c.marks),position:t+1}}case"|":if("{"===e[t=K(e,t+1)]){let p=Y(e,t);if("error"===p.type)return p;return p.marks.unshift({name:"projection",position:r}),p}break;case"{":{let h=Y(e,t);if("error"===h.type)return h;return h.marks.unshift({name:"projection",position:r}),h}}return{type:"error",position:t}}function L(e,t,r){let n=[];if(n.push({name:"func_call",position:t}),":"===e[r]&&":"===e[r+1]){n.push({name:"namespace",position:t}),n.push({name:"ident",position:t},{name:"ident_end",position:r}),r=K(e,r+2);let a=X(e,r,W);if(!a||(n.push({name:"ident",position:r},{name:"ident_end",position:r+a}),"("!==e[r=K(e,r+a)]))return{type:"error",position:r};r++}else n.push({name:"ident",position:t},{name:"ident_end",position:r}),r=K(e,r+1);let s=r;if(")"!==e[r])for(;;){let i=J(e,r,0);if("error"===i.type)return i;if(n=n.concat(i.marks),s=i.position,","!==e[r=K(e,i.position)]||")"===e[r=K(e,r+1)])break}return")"!==e[r]?{type:"error",position:r}:(n.push({name:"func_args_end",position:s}),{type:"success",marks:n,position:r+1})}function Y(e,t){let r=[{name:"object",position:t}];for(t=K(e,t+1);"}"!==e[t];){let n=t;if("..."===e.slice(t,t+3)){if("}"!==e[t=K(e,t+3)]&&","!==e[t]){let a=J(e,t,0);if("error"===a.type)return a;r.push({name:"object_splat",position:n}),r=r.concat(a.marks),t=a.position}else r.push({name:"object_splat_this",position:n})}else{let s=J(e,t,0);if("error"===s.type)return s;let i=K(e,s.position);if("str"===s.marks[0].name&&":"===e[i]){let u=J(e,K(e,i+1),0);if("error"===u.type)return u;r.push({name:"object_pair",position:n}),r=r.concat(s.marks,u.marks),t=u.position}else r=r.concat({name:"object_expr",position:t},s.marks),t=s.position}if(","!==e[t=K(e,t)])break;t=K(e,t+1)}return"}"!==e[t]?{type:"error",position:t}:(t++,r.push({name:"object_end",position:t}),{type:"success",marks:r,position:t})}function K(e,t){return t+X(e,t,Z)}function X(e,t,r){let n=r.exec(e.slice(t));return n?n[0].length:0}function ee(e,t,r){let n=r.exec(e.slice(t));return n?n[0]:null}function et(e,t){return function(r){return t(e(r))}}function er(e){return function(t){return{type:"Map",base:t,expr:e({type:"This"})}}}function en(e,t){if(!t)return{type:"a-a",build:e};switch(t.type){case"a-a":return{type:"a-a",build:et(e,t.build)};case"a-b":return{type:"a-b",build:et(e,t.build)};case"b-b":return{type:"a-a",build:et(e,er(t.build))};case"b-a":var r;return{type:"a-a",build:et(e,(r=t.build,function(e){return{type:"FlatMap",base:e,expr:r({type:"This"})}}))};default:throw Error("unknown type: ".concat(t.type))}}function ea(e,t){if(!t)return{type:"b-b",build:e};switch(t.type){case"a-a":case"b-a":return{type:"b-a",build:et(e,t.build)};case"a-b":case"b-b":return{type:"b-b",build:et(e,t.build)};default:throw Error("unknown type: ".concat(t.type))}}var es={"==":function(e,t){var r,n;return(r=e,n=t,"string"===r.type&&"string"===n.type||"boolean"===r.type&&"boolean"===n.type||"null"===r.type&&"null"===n.type||"number"===r.type&&"number"===n.type?r.data===n.data:"datetime"===r.type&&"datetime"===n.type&&r.data.equals(n.data))?v:m},"!=":function(e,t){return equality(e,t)?m:v},">":function(e,t){if("stream"===e.type||"stream"===t.type)return b;var r=S(e.data,t.data);return null===r?b:r>0?v:m},">=":function(e,t){if("stream"===e.type||"stream"===t.type)return b;var r=S(e.data,t.data);return null===r?b:r>=0?v:m},"<":function(e,t){if("stream"===e.type||"stream"===t.type)return b;var r=S(e.data,t.data);return null===r?b:r<0?v:m},"<=":function(e,t){if("stream"===e.type||"stream"===t.type)return b;var r=S(e.data,t.data);return null===r?b:r<=0?v:m},in:function(e,t){var r,n,i,u;return a(this,void 0,void 0,function(){var a,c;return s(this,function(a){switch(a.label){case 0:if("path"===t.type){if("string"!==e.type)return[2,b];return[2,t.data.matches(e.data)?v:m]}if(!t.isArray())return[3,13];a.label=1;case 1:a.trys.push([1,6,7,12]),r=o(t),a.label=2;case 2:return[4,r.next()];case 3:if((n=a.sent()).done)return[3,5];if(equality(e,n.value))return[2,v];a.label=4;case 4:return[3,2];case 5:return[3,12];case 6:return i={error:a.sent()},[3,12];case 7:if(a.trys.push([7,,10,11]),!(n&&!n.done&&(u=r.return)))return[3,9];return[4,u.call(r)];case 8:a.sent(),a.label=9;case 9:return[3,11];case 10:if(i)throw i.error;return[7];case 11:return[7];case 12:return[2,m];case 13:return[2,b]}})})},match:function(e,t){return a(this,void 0,void 0,function(){var r,n,a,i;return s(this,function(a){switch(a.label){case 0:return r=[],n=[],[4,P(e,function(e){r=r.concat(T(e))})];case 1:return a.sent(),[4,P(t,function(e){var t;n=n.concat(M(e).map(function(e){return function(t){return t.some(function(t){return e.test(t)})}}))})];case 2:var s,i;if(!a.sent())return[2,m];return s=r,i=n,[2,0!==s.length&&0!==i.length&&i.every(function(e){return e(s)})?v:m]}})})},"+":function(e,t){return"datetime"===e.type&&"number"===t.type?x(e.data.add(t.data)):"number"===e.type&&"number"===t.type?g(e.data+t.data):"string"===e.type&&"string"===t.type?k(e.data+t.data):"object"===e.type&&"object"===t.type?_(n(n({},e.data),t.data)):"array"===e.type&&"array"===t.type?_(e.data.concat(t.data)):e.isArray()&&t.isArray()?new d(function(){return u(this,arguments,function(){var r,n,a,u,c,l,f,p,h,d,y;return s(this,function(a){switch(a.label){case 0:a.trys.push([0,7,8,13]),r=o(e),a.label=1;case 1:return[4,i(r.next())];case 2:if((n=a.sent()).done)return[3,6];return[4,i(n.value)];case 3:return[4,a.sent()];case 4:a.sent(),a.label=5;case 5:return[3,1];case 6:return[3,13];case 7:return p={error:a.sent()},[3,13];case 8:if(a.trys.push([8,,11,12]),!(n&&!n.done&&(h=r.return)))return[3,10];return[4,i(h.call(r))];case 9:a.sent(),a.label=10;case 10:return[3,12];case 11:if(p)throw p.error;return[7];case 12:return[7];case 13:a.trys.push([13,20,21,26]),c=o(t),a.label=14;case 14:return[4,i(c.next())];case 15:if((l=a.sent()).done)return[3,19];return[4,i(l.value)];case 16:return[4,a.sent()];case 17:a.sent(),a.label=18;case 18:return[3,14];case 19:return[3,26];case 20:return d={error:a.sent()},[3,26];case 21:if(a.trys.push([21,,24,25]),!(l&&!l.done&&(y=c.return)))return[3,23];return[4,i(y.call(c))];case 22:a.sent(),a.label=23;case 23:return[3,25];case 24:if(d)throw d.error;return[7];case 25:return[7];case 26:return[2]}})})}):b},"-":function(e,t){return"datetime"===e.type&&"number"===t.type?x(e.data.add(-t.data)):"datetime"===e.type&&"datetime"===t.type?g(e.data.difference(t.data)):"number"===e.type&&"number"===t.type?g(e.data-t.data):b},"*":ei(function(e,t){return e*t}),"/":ei(function(e,t){return e/t}),"%":ei(function(e,t){return e%t}),"**":ei(function(e,t){return Math.pow(e,t)})};function ei(e){return function(t,r){return"number"===t.type&&"number"===r.type?g(e(t.data,r.data)):b}}var eu=function(){function e(e,t,r,n,a){this.isHidden=!1,this.params=e,this.source=t,this.value=r,this.context=n,this.parent=a}return e.prototype.createNested=function(t){return this.isHidden?new e(this.params,this.source,t,this.context,this.parent):new e(this.params,this.source,t,this.context,this)},e.prototype.createHidden=function(e){var t=this.createNested(e);return t.isHidden=!0,t},e}();function eo(e,t,r){return void 0===r&&(r=eo),(0,el[e.type])(e,t,r)}function ec(e,t){return"then"in e?e.then(t):t(e)}var el={This:function(e,t){return t.value},Selector:function(){throw Error("Selectors can not be evaluated")},Everything:function(e,t){return t.source},Parameter:function(e,t){var r=e.name;return _(t.params[r])},Context:function(e,t){var r=e.key;if("before"===r||"after"===r)return t.context[r]||b;throw Error("unknown context key: ".concat(r))},Parent:function(e,t){for(var r=e.n,n=t,a=0;a<r;a++){if(!n.parent)return b;n=n.parent}return n.value},OpCall:function(e,t,r){var n=e.op,i=e.left,u=e.right,o=es[n];if(!o)throw Error("Unknown operator: ".concat(n));var c=r(i,t),l=r(u,t);return"then"in c||"then"in l?a(this,void 0,void 0,function(){var e,t;return s(this,function(r){switch(r.label){case 0:return e=o,[4,c];case 1:return t=[r.sent()],[4,l];case 2:return[2,e.apply(void 0,t.concat([r.sent()]))]}})}):o(c,l)},Select:function(e,t,r){var n=e.alternatives,i=e.fallback;return a(this,void 0,void 0,function(){var e,a,u,o;return s(this,function(s){switch(s.label){case 0:e=0,a=n,s.label=1;case 1:if(!(e<a.length))return[3,4];return[4,r((u=a[e]).condition,t)];case 2:if("boolean"===(o=s.sent()).type&&!0===o.data)return[2,r(u.value,t)];s.label=3;case 3:return e++,[3,1];case 4:if(i)return[2,r(i,t)];return[2,b]}})})},InRange:function(e,t,r){var n=e.base,i=e.left,u=e.right,o=e.isInclusive;return a(this,void 0,void 0,function(){var e,a,c,l,f,p,h,d,y;return s(this,function(s){switch(s.label){case 0:return[4,r(n,t)];case 1:return e=s.sent(),[4,r(i,t)];case 2:return a=s.sent(),[4,r(u,t)];case 3:return c=s.sent(),f=S,[4,e.get()];case 4:return p=[s.sent()],[4,a.get()];case 5:if(null===(l=f.apply(void 0,p.concat([s.sent()]))))return[2,b];return d=S,[4,e.get()];case 6:return y=[s.sent()],[4,c.get()];case 7:if(null===(h=d.apply(void 0,y.concat([s.sent()]))))return[2,b];if(o)return[2,l>=0&&h<=0?v:m];return[2,l>=0&&h<0?v:m]}})})},Filter:function(e,t,r){var n=e.base,c=e.expr;return a(this,void 0,void 0,function(){var e;return s(this,function(a){switch(a.label){case 0:return[4,r(n,t)];case 1:if(!(e=a.sent()).isArray())return[2,b];return[2,new d(function(){return u(this,arguments,function(){var n,a,u,l,f,p,h,d;return s(this,function(s){switch(s.label){case 0:s.trys.push([0,8,9,14]),n=o(e),s.label=1;case 1:return[4,i(n.next())];case 2:if((a=s.sent()).done)return[3,7];return u=a.value,[4,i(r(c,t.createNested(u)))];case 3:if(!("boolean"===(f=s.sent()).type&&!0===f.data))return[3,6];return[4,i(u)];case 4:return[4,s.sent()];case 5:s.sent(),s.label=6;case 6:return[3,1];case 7:return[3,14];case 8:return h={error:s.sent()},[3,14];case 9:if(s.trys.push([9,,12,13]),!(a&&!a.done&&(d=n.return)))return[3,11];return[4,i(d.call(n))];case 10:s.sent(),s.label=11;case 11:return[3,13];case 12:if(h)throw h.error;return[7];case 13:return[7];case 14:return[2]}})})})]}})})},Projection:function(e,t,r){var n=e.base,i=e.expr;return a(this,void 0,void 0,function(){var e,a;return s(this,function(a){switch(a.label){case 0:return[4,r(n,t)];case 1:if("object"!==(e=a.sent()).type)return[2,b];return[2,r(i,t.createNested(e))]}})})},FuncCall:function(e,t,r){var n;return(0,e.func)(e.args,t,r)},PipeFuncCall:function(e,t,r){var n=e.func,i=e.base,u=e.args;return a(this,void 0,void 0,function(){var e;return s(this,function(e){switch(e.label){case 0:return[4,r(i,t)];case 1:return[2,n(e.sent(),u,t,r)]}})})},AccessAttribute:function(e,t,r){var n=e.base,i=e.name;return a(this,void 0,void 0,function(){var e;return s(this,function(a){switch(a.label){case 0:if(e=t.value,!n)return[3,2];return[4,r(n,t)];case 1:e=a.sent(),a.label=2;case 2:if("object"===e.type&&e.data.hasOwnProperty(i))return[2,_(e.data[i])];return[2,b]}})})},AccessElement:function(e,t,r){var n=e.base,i=e.index;return a(this,void 0,void 0,function(){var e,a,u;return s(this,function(s){switch(s.label){case 0:return[4,r(n,t)];case 1:if(!(e=s.sent()).isArray())return[2,b];return[4,e.get()];case 2:return[2,_((a=s.sent())[i<0?i+a.length:i])]}})})},Slice:function(e,t,r){var n=e.base,i=e.left,u=e.right,o=e.isInclusive;return a(this,void 0,void 0,function(){var e,a,c,l;return s(this,function(s){switch(s.label){case 0:return[4,r(n,t)];case 1:if(!(e=s.sent()).isArray())return[2,b];return[4,e.get()];case 2:return a=s.sent(),c=i,l=u,c<0&&(c=a.length+c),l<0&&(l=a.length+l),o&&l++,c<0&&(c=0),l<0&&(l=0),[2,_(a.slice(c,l))]}})})},Deref:function(e,t,r){var n,i,u=e.base;return a(this,void 0,void 0,function(){var e,a,c,l,f,p;return s(this,function(s){switch(s.label){case 0:return[4,r(u,t)];case 1:if(e=s.sent(),!t.source.isArray()||"object"!==e.type||"string"!=typeof(a=e.data._ref))return[2,b];s.label=2;case 2:s.trys.push([2,7,8,13]),c=o(t.source),s.label=3;case 3:return[4,c.next()];case 4:if((l=s.sent()).done)return[3,6];if("object"===(f=l.value).type&&a===f.data._id)return[2,f];s.label=5;case 5:return[3,3];case 6:return[3,13];case 7:return n={error:s.sent()},[3,13];case 8:if(s.trys.push([8,,11,12]),!(l&&!l.done&&(i=c.return)))return[3,10];return[4,i.call(c)];case 9:s.sent(),s.label=10;case 10:return[3,12];case 11:if(n)throw n.error;return[7];case 12:return[7];case 13:return[2,b]}})})},Value:function(e){return _(e.value)},Group:function(e,t,r){return r(e.base,t)},Object:function(e,t,r){var n=e.attributes;return a(this,void 0,void 0,function(){var e,a,i,u,o,c,l,f,p,h;return s(this,function(s){switch(s.label){case 0:e={},a=0,i=n,s.label=1;case 1:if(!(a<i.length))return[3,12];switch(o=(u=i[a]).type,c=u.type){case"ObjectAttributeValue":return[3,2];case"ObjectConditionalSplat":return[3,5];case"ObjectSplat":return[3,8]}return[3,10];case 2:case 8:return[4,r(u.value,t)];case 3:return l=s.sent(),f=e,p=u.name,[4,l.get()];case 4:return f[p]=s.sent(),[3,11];case 5:return[4,r(u.condition,t)];case 6:if("boolean"!==(h=s.sent()).type||!1===h.data)return[3,11];return[4,r(u.value,t)];case 7:case 9:return"object"===(l=s.sent()).type&&Object.assign(e,l.data),[3,11];case 10:throw Error("Unknown node type: ".concat(o));case 11:return a++,[3,1];case 12:return[2,_(e)]}})})},Array:function(e,t,r){var n=e.elements;return new d(function(){return u(this,arguments,function(){var e,a,u,c,l,f,p,h,d,y;return s(this,function(s){switch(s.label){case 0:e=0,a=n,s.label=1;case 1:if(!(e<a.length))return[3,21];return[4,i(r((u=a[e]).value,t))];case 2:if(c=s.sent(),!u.isSplat)return[3,17];if(!c.isArray())return[3,16];s.label=3;case 3:s.trys.push([3,10,11,16]),d=void 0,l=o(c),s.label=4;case 4:return[4,i(l.next())];case 5:if((f=s.sent()).done)return[3,9];return[4,i(f.value)];case 6:return[4,s.sent()];case 7:s.sent(),s.label=8;case 8:return[3,4];case 9:return[3,16];case 10:return d={error:s.sent()},[3,16];case 11:if(s.trys.push([11,,14,15]),!(f&&!f.done&&(y=l.return)))return[3,13];return[4,i(y.call(l))];case 12:s.sent(),s.label=13;case 13:return[3,15];case 14:if(d)throw d.error;return[7];case 15:return[7];case 16:return[3,20];case 17:return[4,i(c)];case 18:return[4,s.sent()];case 19:s.sent(),s.label=20;case 20:return e++,[3,1];case 21:return[2]}})})})},Tuple:function(){throw Error("tuples can not be evaluated")},Or:function(e,t,r){var n=e.left,i=e.right;return a(this,void 0,void 0,function(){var e,a;return s(this,function(s){switch(s.label){case 0:return[4,r(n,t)];case 1:return e=s.sent(),[4,r(i,t)];case 2:if(a=s.sent(),"boolean"===e.type&&!0===e.data||"boolean"===a.type&&!0===a.data)return[2,v];if("boolean"!==e.type||"boolean"!==a.type)return[2,b];return[2,m]}})})},And:function(e,t,r){var n=e.left,i=e.right;return a(this,void 0,void 0,function(){var e,a;return s(this,function(s){switch(s.label){case 0:return[4,r(n,t)];case 1:return e=s.sent(),[4,r(i,t)];case 2:if(a=s.sent(),"boolean"===e.type&&!1===e.data||"boolean"===a.type&&!1===a.data)return[2,m];if("boolean"!==e.type||"boolean"!==a.type)return[2,b];return[2,v]}})})},Not:function(e,t,r){var n=e.base;return a(this,void 0,void 0,function(){var e;return s(this,function(a){switch(a.label){case 0:return[4,r(n,t)];case 1:if("boolean"!==(e=a.sent()).type)return[2,b];return[2,e.data?m:v]}})})},Neg:function(e,t,r){return ec(r(e.base,t),function(e){return"number"!==e.type?b:g(-e.data)})},Pos:function(e,t,r){return ec(r(e.base,t),function(e){return"number"!==e.type?b:g(e.data)})},Asc:function(){return b},Desc:function(){return b},ArrayCoerce:function(e,t,r){var n=e.base;return a(this,void 0,void 0,function(){var e;return s(this,function(a){switch(a.label){case 0:return[4,r(n,t)];case 1:return[2,(e=a.sent()).isArray()?e:b]}})})},Map:function(e,t,r){var n=e.base,c=e.expr;return a(this,void 0,void 0,function(){var e;return s(this,function(a){switch(a.label){case 0:return[4,r(n,t)];case 1:if(!(e=a.sent()).isArray())return[2,b];return[2,new d(function(){return u(this,arguments,function(){var n,a,u,l,f,p,h;return s(this,function(s){switch(s.label){case 0:s.trys.push([0,8,9,14]),n=o(e),s.label=1;case 1:return[4,i(n.next())];case 2:if((a=s.sent()).done)return[3,7];return u=a.value,[4,i(r(c,t.createHidden(u)))];case 3:return[4,i.apply(void 0,[s.sent()])];case 4:return[4,s.sent()];case 5:s.sent(),s.label=6;case 6:return[3,1];case 7:return[3,14];case 8:return p={error:s.sent()},[3,14];case 9:if(s.trys.push([9,,12,13]),!(a&&!a.done&&(h=n.return)))return[3,11];return[4,i(h.call(n))];case 10:s.sent(),s.label=11;case 11:return[3,13];case 12:if(p)throw p.error;return[7];case 13:return[7];case 14:return[2]}})})})]}})})},FlatMap:function(e,t,r){var n=e.base,c=e.expr;return a(this,void 0,void 0,function(){var e;return s(this,function(a){switch(a.label){case 0:return[4,r(n,t)];case 1:if(!(e=a.sent()).isArray())return[2,b];return[2,new d(function(){return u(this,arguments,function(){var n,a,u,l,f,p,h,d,y,b,v,m,w,g;return s(this,function(s){switch(s.label){case 0:s.trys.push([0,23,24,29]),n=o(e),s.label=1;case 1:return[4,i(n.next())];case 2:if((a=s.sent()).done)return[3,22];return u=a.value,[4,i(r(c,t.createHidden(u)))];case 3:if(!(f=s.sent()).isArray())return[3,18];s.label=4;case 4:s.trys.push([4,11,12,17]),w=void 0,p=o(f),s.label=5;case 5:return[4,i(p.next())];case 6:if((h=s.sent()).done)return[3,10];return[4,i(h.value)];case 7:return[4,s.sent()];case 8:s.sent(),s.label=9;case 9:return[3,5];case 10:return[3,17];case 11:return w={error:s.sent()},[3,17];case 12:if(s.trys.push([12,,15,16]),!(h&&!h.done&&(g=p.return)))return[3,14];return[4,i(g.call(p))];case 13:s.sent(),s.label=14;case 14:return[3,16];case 15:if(w)throw w.error;return[7];case 16:return[7];case 17:return[3,21];case 18:return[4,i(f)];case 19:return[4,s.sent()];case 20:s.sent(),s.label=21;case 21:return[3,1];case 22:return[3,29];case 23:return v={error:s.sent()},[3,29];case 24:if(s.trys.push([24,,27,28]),!(a&&!a.done&&(m=n.return)))return[3,26];return[4,i(m.call(n))];case 25:s.sent(),s.label=26;case 26:return[3,28];case 27:if(v)throw v.error;return[7];case 28:return[7];case 29:return[2]}})})})]}})})}},ef=new eu({},b,b,{timestamp:new Date(0),identity:"me",before:null,after:null},null);function ep(e){return!function e(t){switch(t.type){case"Group":case"Value":case"Parameter":return!0;case"Pos":case"Neg":return e(t.base);case"OpCall":switch(t.op){case"+":case"-":case"*":case"/":case"%":case"**":return e(t.left)&&e(t.right);default:return!1}default:return!1}}(e)?null:function e(t){var r=eo(t,ef,e);if("then"in r)throw Error("BUG: constant evaluate should never return a promise");return r}(e)}var eh={"'":"'",'"':'"',"\\":"\\","/":"/",b:"\b",f:"\f",n:"\n",r:"\r",t:"	"};function ed(e){return String.fromCharCode(parseInt(e,16))}var ey=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.name="GroqQueryError",t}return r(t,e),t}(Error),eb={group:function(e){return{type:"Group",base:e.process(eb)}},everything:function(){return{type:"Everything"}},this:function(){return{type:"This"}},parent:function(){return{type:"Parent",n:1}},dblparent:function(e){return{type:"Parent",n:e.process(eb).n+1}},traverse:function(e){for(var t=e.process(eb),r=[];"traversal_end"!==e.getMark().name;)r.push(e.process(em));e.shift();for(var n=null,a=r.length-1;a>=0;a--)n=r[a](n);if(("Everything"===t.type||"Array"===t.type||"PipeFuncCall"===t.type)&&(n=en(function(e){return e},n)),null===n)throw Error("BUG: unexpected empty traversal");return n.build(t)},this_attr:function(e){var t=e.processString();return"null"===t?{type:"Value",value:null}:"true"===t?{type:"Value",value:!0}:"false"===t?{type:"Value",value:!1}:{type:"AccessAttribute",name:t}},neg:function(e){return{type:"Neg",base:e.process(eb)}},pos:function(e){return{type:"Pos",base:e.process(eb)}},add:function(e){var t=e.process(eb),r=e.process(eb);return{type:"OpCall",op:"+",left:t,right:r}},sub:function(e){var t=e.process(eb),r=e.process(eb);return{type:"OpCall",op:"-",left:t,right:r}},mul:function(e){var t=e.process(eb),r=e.process(eb);return{type:"OpCall",op:"*",left:t,right:r}},div:function(e){var t=e.process(eb),r=e.process(eb);return{type:"OpCall",op:"/",left:t,right:r}},mod:function(e){var t=e.process(eb),r=e.process(eb);return{type:"OpCall",op:"%",left:t,right:r}},pow:function(e){var t=e.process(eb),r=e.process(eb);return{type:"OpCall",op:"**",left:t,right:r}},comp:function(e){var t=e.process(eb),r=e.processString(),n=e.process(eb);return{type:"OpCall",op:r,left:t,right:n}},in_range:function(e){var t=e.process(eb),r="inc_range"===e.getMark().name;e.shift();var n=e.process(eb),a=e.process(eb);return{type:"InRange",base:t,left:n,right:a,isInclusive:r}},str:function(e){var t="";loop:for(;e.hasMark();){var r=e.getMark();switch(r.name){case"str_end":t+=e.processStringEnd();break loop;case"str_pause":t+=e.processStringEnd();break;case"str_start":e.shift();break;case"single_escape":var n=e.slice(1);e.shift(),t+=eh[n];break;case"unicode_hex":e.shift(),t+=ed(e.processStringEnd());break;default:throw Error("unexpected mark: ".concat(r.name))}}return{type:"Value",value:t}},integer:function(e){return{type:"Value",value:Number(e.processStringEnd())}},float:function(e){return{type:"Value",value:Number(e.processStringEnd())}},sci:function(e){return{type:"Value",value:Number(e.processStringEnd())}},object:function(e){for(var t=[];"object_end"!==e.getMark().name;)t.push(e.process(ev));return e.shift(),{type:"Object",attributes:t}},array:function(e){for(var t=[];"array_end"!==e.getMark().name;){var r=!1;"array_splat"===e.getMark().name&&(r=!0,e.shift());var n=e.process(eb);t.push({type:"ArrayElement",value:n,isSplat:r})}return e.shift(),{type:"Array",elements:t}},tuple:function(e){for(var t=[];"tuple_end"!==e.getMark().name;)t.push(e.process(eb));return e.shift(),{type:"Tuple",members:t}},func_call:function(e){var t="global";"namespace"===e.getMark().name&&(e.shift(),t=e.processString());var r=e.processString();if("global"===t&&"select"===r){for(var n={type:"Select",alternatives:[]};"func_args_end"!==e.getMark().name;)if("pair"===e.getMark().name){if(n.fallback)throw new ey("unexpected argument to select()");e.shift();var a=e.process(eb),s=e.process(eb);n.alternatives.push({type:"SelectAlternative",condition:a,value:s})}else{if(n.fallback)throw new ey("unexpected argument to select()");var s=e.process(eb);n.fallback=s}return e.shift(),n}for(var i=[];"func_args_end"!==e.getMark().name;)ek(t,r,i.length)?(e.process(ew),i.push({type:"Selector"})):i.push(e.process(eb));if(e.shift(),"global"===t&&("before"===r||"after"===r)&&"delta"===e.parseOptions.mode)return{type:"Context",key:r};if("global"===t&&"boost"===r&&!e.allowBoost)throw new ey("unexpected boost");var u=R[t];if(!u)throw new ey("Undefined namespace: ".concat(t));var o=u[r];if(!o||(void 0!==o.arity&&eg(r,o.arity,i.length),void 0!==o.mode&&o.mode!==e.parseOptions.mode))throw new ey("Undefined function: ".concat(r));return{type:"FuncCall",func:o,name:r,args:i}},pipecall:function(e){var t=e.process(eb);e.shift();var r="global";if("namespace"===e.getMark().name&&(e.shift(),r=e.processString()),"global"!==r)throw new ey("Undefined namespace: ".concat(r));var n=e.processString(),a=[],s=e.allowBoost;for("score"===n&&(e.allowBoost=!0);;){var i=e.getMark().name;if("func_args_end"===i)break;if("order"===n){if("asc"===i){e.shift(),a.push({type:"Asc",base:e.process(eb)});continue}if("desc"===i){e.shift(),a.push({type:"Desc",base:e.process(eb)});continue}}a.push(e.process(eb))}e.shift(),e.allowBoost=s;var u=G[n];if(!u)throw new ey("Undefined pipe function: ".concat(n));return u.arity&&eg(n,u.arity,a.length),{type:"PipeFuncCall",func:u,base:t,name:n,args:a}},pair:function(e){throw new ey("unexpected =>")},and:function(e){var t=e.process(eb),r=e.process(eb);return{type:"And",left:t,right:r}},or:function(e){var t=e.process(eb),r=e.process(eb);return{type:"Or",left:t,right:r}},not:function(e){return{type:"Not",base:e.process(eb)}},asc:function(e){throw new ey("unexpected asc")},desc:function(e){throw new ey("unexpected desc")},param:function(e){var t=e.processString();return e.parseOptions.params&&e.parseOptions.params.hasOwnProperty(t)?{type:"Value",value:e.parseOptions.params[t]}:{type:"Parameter",name:t}}},ev={object_expr:function(e){if("pair"===e.getMark().name){e.shift();var t=e.process(eb),r=e.process(eb);return{type:"ObjectConditionalSplat",condition:t,value:r}}var n=e.process(eb);return{type:"ObjectAttributeValue",name:function e(t){if("AccessAttribute"===t.type&&!t.base)return t.name;if("Deref"===t.type||"Map"===t.type||"Projection"===t.type||"Slice"===t.type||"Filter"===t.type||"AccessElement"===t.type||"ArrayCoerce"===t.type)return e(t.base);throw new ey("Cannot determine property key for type: ".concat(t.type))}(n),value:n}},object_pair:function(e){var t=e.process(eb);if("Value"!==t.type)throw Error("name must be string");var r=e.process(eb);return{type:"ObjectAttributeValue",name:t.value,value:r}},object_splat:function(e){return{type:"ObjectSplat",value:e.process(eb)}},object_splat_this:function(){return{type:"ObjectSplat",value:{type:"This"}}}},em={square_bracket:function(e){var t=e.process(eb),r=ep(t);return r&&"number"===r.type?function(e){return function(e,t){if(!t)return{type:"a-b",build:e};switch(t.type){case"a-a":case"b-a":return{type:"a-a",build:et(e,t.build)};case"a-b":case"b-b":return{type:"a-b",build:et(e,t.build)};default:throw Error("unknown type: ".concat(t.type))}}(function(e){return{type:"AccessElement",base:e,index:r.data}},e)}:r&&"string"===r.type?function(e){return ea(function(e){return{type:"AccessAttribute",base:e,name:r.data}},e)}:function(e){return en(function(e){return{type:"Filter",base:e,expr:t}},e)}},slice:function(e){var t="inc_range"===e.getMark().name;e.shift();var r=e.process(eb),n=e.process(eb),a=ep(r),s=ep(n);if(!a||!s||"number"!==a.type||"number"!==s.type)throw new ey("slicing must use constant numbers");return function(e){return en(function(e){return{type:"Slice",base:e,left:a.data,right:s.data,isInclusive:t}},e)}},projection:function(e){var t=e.process(eb);return function(e){return function(e,t){if(!t)return{type:"b-b",build:e};switch(t.type){case"a-a":return{type:"a-a",build:et(er(e),t.build)};case"a-b":return{type:"a-b",build:et(er(e),t.build)};case"b-a":return{type:"b-a",build:et(e,t.build)};case"b-b":return{type:"b-b",build:et(e,t.build)};default:throw Error("unknown type: ".concat(t.type))}}(function(e){return{type:"Projection",base:e,expr:t}},e)}},attr_access:function(e){var t=e.processString();return function(e){return ea(function(e){return{type:"AccessAttribute",base:e,name:t}},e)}},deref:function(e){var t=null;return"deref_attr"===e.getMark().name&&(e.shift(),t=e.processString()),function(e){return ea(function(e){var r;return r={type:"Deref",base:e},t?{type:"AccessAttribute",base:r,name:t}:r},e)}},array_postfix:function(e){return function(e){return en(function(e){return{type:"ArrayCoerce",base:e}},e)}}},ew={group:function(e){return e.process(ew),null},everything:function(){throw Error("Invalid selector syntax")},this:function(){throw Error("Invalid selector syntax")},parent:function(){throw Error("Invalid selector syntax")},dblparent:function(e){throw Error("Invalid selector syntax")},traverse:function(e){for(e.process(ew);"traversal_end"!==e.getMark().name;)e.process(em);return e.shift(),null},this_attr:function(e){return e.processString(),null},neg:function(e){throw Error("Invalid selector syntax")},pos:function(e){throw Error("Invalid selector syntax")},add:function(e){throw Error("Invalid selector syntax")},sub:function(e){throw Error("Invalid selector syntax")},mul:function(e){throw Error("Invalid selector syntax")},div:function(e){throw Error("Invalid selector syntax")},mod:function(e){throw Error("Invalid selector syntax")},pow:function(e){throw Error("Invalid selector syntax")},comp:function(e){throw Error("Invalid selector syntax")},in_range:function(e){throw Error("Invalid selector syntax")},str:function(e){throw Error("Invalid selector syntax")},integer:function(e){throw Error("Invalid selector syntax")},float:function(e){throw Error("Invalid selector syntax")},sci:function(e){throw Error("Invalid selector syntax")},object:function(e){throw Error("Invalid selector syntax")},array:function(e){throw Error("Invalid selector syntax")},tuple:function(e){throw Error("Invalid selector syntax")},func_call:function(e,t){var r=eb.func_call(e,t);if("anywhere"===r.name&&1===r.args.length)return null;throw Error("Invalid selector syntax")},pipecall:function(e){throw Error("Invalid selector syntax")},pair:function(e){throw Error("Invalid selector syntax")},and:function(e){throw Error("Invalid selector syntax")},or:function(e){throw Error("Invalid selector syntax")},not:function(e){throw Error("Invalid selector syntax")},asc:function(e){throw Error("Invalid selector syntax")},desc:function(e){throw Error("Invalid selector syntax")},param:function(e){throw Error("Invalid selector syntax")}};function eg(e,t,r){if("number"==typeof t){if(r!==t)throw new ey("Incorrect number of arguments to function ".concat(e,"(). Expected ").concat(t,", got ").concat(r,"."))}else if(t&&!t(r))throw new ey("Incorrect number of arguments to function ".concat(e,"()."))}function ek(e,t,r){return"diff"==e&&2==r&&["changedAny","changedOnly"].includes(t)}var ex=function(e){function t(t){var r=e.call(this,"Syntax error in GROQ query at position ".concat(t))||this;return r.name="GroqSyntaxError",r.position=t,r}return r(t,e),t}(Error);e.evaluate=function(e,t){void 0===t&&(t={});var r=_(t.root),a=_(t.dataset),s=n({},t.params),i=new eu(s,a,r,{timestamp:t.timestamp||new Date,identity:void 0===t.identity?"me":t.identity,sanity:t.sanity,after:t.after?_(t.after):null,before:t.before?_(t.before):null},null);return eo(e,i)},e.parse=function(e,t){void 0===t&&(t={});let r,n;var a,s=(r=K(e,r=0),"error"===(n=J(e,r,0)).type?n:(r=K(e,n.position))!==e.length?(n.failPosition&&(r=n.failPosition-1),{type:"error",position:r}):(delete n.position,delete n.failPosition,n));if("error"===s.type)throw new ex(s.position);return new c(e,s.marks,t).process(eb)},Object.defineProperty(e,"__esModule",{value:!0})})(t)}}]);